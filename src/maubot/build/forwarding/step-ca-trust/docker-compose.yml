services:
  maubot:
    container_name: maubot
    image: dock.mau.dev/maubot/maubot:latest
    restart: unless-stopped
    configs:
      - source: app-config
        target: /data/config.yaml
    volumes:
      - maubot-data:${MAUBOT_DB_FOLDER:-/data}
    ports:
      - 29316:29316
    environment:
      STEP_CA_TRUST: ${STEP_CA_TRUST:-true}
      STEP_CA_TRUST_RESTART: ${STEP_CA_TRUST_RESTART:-true}
volumes:
  maubot-data:
    name: maubot-data
configs:
  app-config:
    content: |
      database: sqlite:${MAUBOT_DB_FOLDER:-/data}/maubot.db
      crypto_database: default
      database_opts:
        min_size: 1
        max_size: 10
      plugin_directories:
        upload: ${MAUBOT_DB_FOLDER:-/data}/plugins
        load:
        - ${MAUBOT_DB_FOLDER:-/data}/plugins
        trash: ${MAUBOT_DB_FOLDER:-/data}/trash

      plugin_databases:
        sqlite: ${MAUBOT_DB_FOLDER:-/data}/dbs

      server:
        hostname: 0.0.0.0
        port: 29316
        public_url: ${MAUBOT_PUBLIC_URL}
        ui_base_path: ${MAUBOT_UI_BASE_PATH}
        plugin_base_path: ${MAUBOT_PLUGIN_BASE_PATH}
        override_resource_path: /opt/maubot/frontend
        unshared_secret: ${MAUBOT_UNSHARED_SECRET}

      homeservers:
        ${MAUBOT_HOMESERVER_NAME}:
          url: ${MAUBOT_HOMESERVER_URL}
          secret: ${MAUBOT_HOMESERVER_SECRET}
      admins:
        ${MAUBOT_ADMIN_USERNAME}: '${MAUBOT_ADMIN_PASSWORD}'
      api_features:
        login: true
        plugin: true
        plugin_upload: true
        instance: true
        instance_database: true
        client: true
        client_proxy: true
        client_auth: true
        dev_open: true
        log: true

      logging:
        version: 1
        formatters:
          colored:
            (): maubot.lib.color_log.ColorFormatter
            format: '[%(asctime)s] [%(levelname)s@%(name)s] %(message)s'
          normal:
            format: '[%(asctime)s] [%(levelname)s@%(name)s] %(message)s'
        handlers:
          file:
            class: logging.handlers.RotatingFileHandler
            formatter: normal
            filename: /var/log/maubot.log
            maxBytes: 10485760
            backupCount: 10
          console:
            class: logging.StreamHandler
            formatter: colored
        loggers:
          maubot:
            level: DEBUG
          mau:
            level: DEBUG
          aiohttp:
            level: INFO
        root:
          level: DEBUG
          handlers: [file, console]
